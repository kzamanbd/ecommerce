import os
import requests

# Retrieve environment variables
author_name = os.environ.get("AUTHOR_NAME")
branch_name = os.environ.get("BRANCH_NAME")
release_notes = os.environ.get("RELEASE_NOTES")
build_result = os.environ.get("BUILD_RESULT")
github_run_id = os.environ.get('GITHUB_RUN_ID')
github_actor = os.environ.get('GITHUB_ACTOR')

url = "https://devweb.jerpbd.com/features/users/dashboard"
origin = "Development"
if branch_name == "release/prod-vue3x":
    url = "https://njpl.jerpbd.com/features/users/dashboard"
    origin = "Production Environment"
elif branch_name == "release/version-vue3x":
    origin = "Development Environment"
    
try:
    response = requests.get(f"https://api.github.com/users/{github_actor}")
    data = response.json()
    author_name = data.get("name", author_name)
    print(author_name)
        
except Exception as e:
    print("Failed to fetch author name from GitHub API")
    

# Create the message to be sent
message = f"""
ğŸ‰ **New Release Deployed!**

-------------------

ğŸ‘¤ **Released By:**
    {author_name}

ğŸŒ¿ **Branch Name:**
    {branch_name}

-------------------

ğŸŒ **Origin:**
    {origin}

-------------------

ğŸ“ **Release Notes:**
{release_notes}

-------------------

ğŸ’» **More Details:**
    {url}

-------------------

We are excited to announce the successful deployment of the latest release! ğŸš€

ğŸ“ **N.B.:** This message is automatically generated by the CI/CD pipeline to notify you of the latest deployment status. ğŸš€
Thank you! ğŸ™
"""

error_message = f"""
ğŸš¨ **Deployment Alert!**

-------------------

âŒ **Build Failed**

-------------------

ğŸ‘¤ **Triggered By:**
    {author_name}

-------------------

ğŸŒ¿ **Branch Name:**
    {branch_name}

-------------------

ğŸ“„ **Error Details:**
https://github.com/mononsoft/jerp-frontend/actions/runs/{github_run_id}

-------------------

ğŸŒ **Origin:**
    {origin}

-------------------

Please address the issue as soon as possible.

ğŸ“ **N.B.:** This message is automatically generated by the CI/CD pipeline to notify you of the latest deployment status. ğŸš€
Thank you! ğŸ™
"""

cancelled_message = f"""
ğŸ›‘ **Deployment Cancelled**

-------------------

âŒ **Build Cancelled**

ğŸ‘¤ **Triggered By:**
    {author_name}

ğŸŒ¿ **Branch Name:**
    {branch_name}

-------------------

ğŸ“„ **Error Details:**
https://github.com/mononsoft/jerp-frontend/actions/runs/{github_run_id}

-------------------

The deployment process was cancelled.

ğŸ“ **N.B.:** This message is automatically generated by the CI/CD pipeline to notify you of the latest deployment status. ğŸš€
Thank you! ğŸ™
"""

if build_result == "failure":
    message = error_message
elif build_result == "cancelled":
    message = cancelled_message

# Function to send the message through Skype bot
print(message)
